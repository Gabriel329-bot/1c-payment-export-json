#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    Объект.ДатаНачала = НачалоМесяца(ТекущаяДата());
    Объект.ДатаОкончания = КонецДня(ТекущаяДата());
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СформироватьИПоказатьJSON(Команда)
    
    Если НЕ ЗначениеЗаполнено(Объект.ДатаНачала) Тогда
        Сообщить("Укажите дату начала периода!");
        Возврат;
    КонецЕсли;
    
    Если НЕ ЗначениеЗаполнено(Объект.ДатаОкончания) Тогда
        Сообщить("Укажите дату окончания периода!");
        Возврат;
    КонецЕсли;
    
    КоличествоДоговоров = СформироватьОтчетИJSON_НаСервере();
    
    Если КоличествоДоговоров = 0 Тогда
        Сообщить("Нет данных за выбранный период или не заполнены договоры!");
        Возврат;
    КонецЕсли;
    
    Элементы.СтраницаПредпросмотр.Видимость = Истина;
    Элементы.СтраницаОтчет.Видимость = Ложь;
    
    Сообщить("Сформировано договоров: " + КоличествоДоговоров);
    
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьВTessa(Команда)
    
    Если ПустаяСтрока(Объект.ТекстJSON) Тогда
        Сообщить("Нет данных для отправки! Сначала сформируйте отчёт.");
        Возврат;
    КонецЕсли;
    
    Результат = ОтправитьJSON_НаСервере();
    
    Если Результат.Успешно Тогда
        Сообщить("Данные успешно отправлены в Tessa!");
        Сообщить("Код ответа: " + Результат.КодОтвета);
    Иначе
        Сообщить("Ошибка отправки: " + Результат.ТекстОшибки);
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура СохранитьJSONВФайл(Команда)
    
    Если ПустаяСтрока(Объект.ТекстJSON) Тогда
        Сообщить("Нет данных для сохранения!");
        Возврат;
    КонецЕсли;
    
    ИмяФайла = "MIDUpdateRequest_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".json";
    
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
    Диалог.Заголовок = "Сохранить JSON файл";
    Диалог.ПолноеИмяФайла = ИмяФайла;
    Диалог.Фильтр = "Файлы JSON (*.json)|*.json|Все файлы (*.*)|*.*";
    
    Если Диалог.Выбрать() Тогда
        
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        ТекстовыйДокумент.УстановитьТекст(Объект.ТекстJSON);
        
        Попытка
            ТекстовыйДокумент.Записать(Диалог.ПолноеИмяФайла, КодировкаТекста.UTF8);
            Сообщить("Файл сохранён: " + Диалог.ПолноеИмяФайла);
        Исключение
            Сообщить("Ошибка сохранения: " + ОписаниеОшибки());
        КонецПопытки;
        
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура ВернутьсяКОтчету(Команда)
    
    Элементы.СтраницаОтчет.Видимость = Истина;
    Элементы.СтраницаПредпросмотр.Видимость = Ложь;
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция СформироватьОтчетИJSON_НаСервере()
    
    Объект.ТекстJSON = "";
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ПлатежиОстатки.Договор КАК Договор,
    |    ПлатежиОстатки.СуммаСписанийОстаток КАК СуммаСписаний,
    |    ПлатежиОстатки.СуммаПоступленийОстаток КАК СуммаПоступлений
    |ИЗ
    |    РегистрНакопления.ПлатежиПоДоговорам.Остатки(&ДатаОкончания, ) КАК ПлатежиОстатки
    |ГДЕ
    |    (ПлатежиОстатки.СуммаСписанийОстаток > 0
    |        ИЛИ ПлатежиОстатки.СуммаПоступленийОстаток > 0)";
    
    Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));
    
    Результат = Запрос.Выполнить();
    
    Если Результат.Пустой() Тогда
        Возврат 0;
    КонецЕсли;
    
    МассивДоговоровJSON = Новый Массив;
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        ActualPayment = Выборка.СуммаСписаний - Выборка.СуммаПоступлений;
        
        СтруктураДоговора = Новый Структура;
        СтруктураДоговора.Вставить("GUID", ПолучитьTessaID(Выборка.Договор));
        СтруктураДоговора.Вставить("ActualPayment", ActualPayment);
        СтруктураДоговора.Вставить("ActualDelivery", 0);
        СтруктураДоговора.Вставить("ReconciliationReportDate", Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd"));
        СтруктураДоговора.Вставить("Completed", "Нет");
        
        МассивПлатежей = ПолучитьПлатежиПоДоговору(Выборка.Договор);
        СтруктураДоговора.Вставить("PaymentSchedule", МассивПлатежей);
        
        МассивДоговоровJSON.Добавить(СтруктураДоговора);
        
    КонецЦикла;
    
    СтруктураJSON = Новый Структура;
    СтруктураJSON.Вставить("MIDUpdateRequest", МассивДоговоровJSON);
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Авто, "  "));
    ЗаписатьJSON(ЗаписьJSON, СтруктураJSON);
    Объект.ТекстJSON = ЗаписьJSON.Закрыть();
    
    Возврат МассивДоговоровJSON.Количество();
    
КонецФункции

&НаСервере
Функция ПолучитьПлатежиПоДоговору(Договор)
    
    МассивПлатежей = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Платежи.Регистратор КАК Документ,
    |    Платежи.Период КАК ДатаПлатежа,
    |    Платежи.СуммаСписаний КАК СуммаСписаний,
    |    Платежи.СуммаПоступлений КАК СуммаПоступлений,
    |    Платежи.СуммаНДС КАК СуммаНДС
    |ИЗ
    |    РегистрНакопления.ПлатежиПоДоговорам КАК Платежи
    |ГДЕ
    |    Платежи.Договор = &Договор
    |
    |УПОРЯДОЧИТЬ ПО
    |    Платежи.Период";
    
    Запрос.УстановитьПараметр("Договор", Договор);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Документ = Выборка.Документ;
        
        СтруктураПлатежа = Новый Структура;
        СтруктураПлатежа.Вставить("GUID_Link", XMLСтрока(Документ.УникальныйИдентификатор()));
        СтруктураПлатежа.Вставить("Completed_Link", "1");
        
        Если Выборка.СуммаСписаний > 0 Тогда
            СтруктураПлатежа.Вставить("PaymentType", "Списание");
            СтруктураПлатежа.Вставить("Amount", Выборка.СуммаСписаний);
        Иначе
            СтруктураПлатежа.Вставить("PaymentType", "Поступление");
            СтруктураПлатежа.Вставить("Amount", Выборка.СуммаПоступлений);
        КонецЕсли;
        
        СтруктураПлатежа.Вставить("ScheduledPaymentDate", "");
        СтруктураПлатежа.Вставить("ActualPaymentDate", Формат(Выборка.ДатаПлатежа, "ДФ=yyyy-MM-dd"));
        СтруктураПлатежа.Вставить("VAT_Amount", ?(Выборка.СуммаНДС = Null, 0, Выборка.СуммаНДС));
        СтруктураПлатежа.Вставить("Currency", "RUB");
        СтруктураПлатежа.Вставить("Rate", 1);
        СтруктураПлатежа.Вставить("PaymentDocument", "Платёжное поручение");
        
        МассивПлатежей.Добавить(СтруктураПлатежа);
        
    КонецЦикла;
    
    Возврат МассивПлатежей;
    
КонецФункции

&НаСервере
Функция ПолучитьTessaID(Договор)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    СоответствиеДоговоровTessa.TessaID
    |ИЗ
    |    РегистрСведений.СоответствиеДоговоровTessa КАК СоответствиеДоговоровTessa
    |ГДЕ
    |    СоответствиеДоговоровTessa.ДоговорКонтрагента = &Договор";
    
    Запрос.УстановитьПараметр("Договор", Договор);
    Результат = Запрос.Выполнить();
    
    Если НЕ Результат.Пустой() Тогда
        Выборка = Результат.Выбрать();
        Выборка.Следующий();
        Если ЗначениеЗаполнено(Выборка.TessaID) Тогда
            Возврат СокрЛП(Выборка.TessaID);
        КонецЕсли;
    КонецЕсли;
    
    Возврат "";
    
КонецФункции

&НаСервере
Функция ОтправитьJSON_НаСервере()
    
    Результат = Новый Структура("Успешно, КодОтвета, ТекстОшибки", Ложь, 0, "");
    
    АдресСервера = Константы.АдресСервераTessa.Получить();
    
    Если ПустаяСтрока(АдресСервера) Тогда
        Результат.ТекстОшибки = "Не заполнена константа 'АдресСервераTessa'!";
        Возврат Результат;
    КонецЕсли;
    
    Попытка
        
        СтруктураURL = РазобратьURL(АдресСервера);
        
        Если СтруктураURL = Неопределено Тогда
            Результат.ТекстОшибки = "Некорректный адрес сервера: " + АдресСервера;
            Возврат Результат;
        КонецЕсли;
        
        Если СтруктураURL.Схема = "https" Тогда
            Порт = ?(СтруктураURL.Порт = 0, 443, СтруктураURL.Порт);
            ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL();
        Иначе
            Порт = ?(СтруктураURL.Порт = 0, 80, СтруктураURL.Порт);
            ЗащищенноеСоединение = Неопределено;
        КонецЕсли;
        
        Соединение = Новый HTTPСоединение(
            СтруктураURL.Сервер,
            Порт,
            ,
            ,
            ,
            60,
            ЗащищенноеСоединение
        );
        
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Заголовки.Вставить("Accept", "application/json");
        
        Путь = СтруктураURL.Путь;
        Если ПустаяСтрока(Путь) Тогда
            Путь = "/";
        КонецЕсли;
        
        HTTPЗапрос = Новый HTTPЗапрос(Путь, Заголовки);
        HTTPЗапрос.УстановитьТелоИзСтроки(Объект.ТекстJSON, КодировкаТекста.UTF8);
        
        HTTPОтвет = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
        
        Результат.КодОтвета = HTTPОтвет.КодСостояния;
        
        Если HTTPОтвет.КодСостояния >= 200 И HTTPОтвет.КодСостояния < 300 Тогда
            Результат.Успешно = Истина;
        Иначе
            Результат.ТекстОшибки = "Код ответа: " + HTTPОтвет.КодСостояния + ". Тело: " + HTTPОтвет.ПолучитьТелоКакСтроку();
        КонецЕсли;
        
    Исключение
        Результат.ТекстОшибки = ОписаниеОшибки();
    КонецПопытки;
    
    Возврат Результат;
    
КонецФункции

&НаСервере
Функция РазобратьURL(URL)
    
    Результат = Новый Структура("Схема, Сервер, Порт, Путь", "", "", 0, "");
    
    СтрокаURL = URL;
    
    Если НРег(Лев(СтрокаURL, 8)) = "https://" Тогда
        Результат.Схема = "https";
        СтрокаURL = Сред(СтрокаURL, 9);
    ИначеЕсли НРег(Лев(СтрокаURL, 7)) = "http://" Тогда
        Результат.Схема = "http";
        СтрокаURL = Сред(СтрокаURL, 8);
    Иначе
        Возврат Неопределено;
    КонецЕсли;
    
    ПозицияПути = СтрНайти(СтрокаURL, "/");
    Если ПозицияПути > 0 Тогда
        Результат.Путь = Сред(СтрокаURL, ПозицияПути);
        СтрокаURL = Лев(СтрокаURL, ПозицияПути - 1);
    Иначе
        Результат.Путь = "/";
    КонецЕсли;
    
    ПозицияПорта = СтрНайти(СтрокаURL, ":");
    Если ПозицияПорта > 0 Тогда
        Результат.Сервер = Лев(СтрокаURL, ПозицияПорта - 1);
        Результат.Порт = Число(Сред(СтрокаURL, ПозицияПорта + 1));
    Иначе
        Результат.Сервер = СтрокаURL;
        Результат.Порт = 0;
    КонецЕсли;
    
    Возврат Результат;
    
КонецФункции

#КонецОбласти
