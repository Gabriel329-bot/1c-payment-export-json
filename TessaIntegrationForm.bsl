#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    Объект.ДатаНачала = НачалоМесяца(ТекущаяДата());
    Объект.ДатаОкончания = КонецДня(ТекущаяДата());
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СформироватьИПоказатьJSON(Команда)
    
    Если НЕ ЗначениеЗаполнено(Объект.ДатаНачала) Тогда
        Сообщить("Укажите дату начала периода!");
        Возврат;
    КонецЕсли;
    
    Если НЕ ЗначениеЗаполнено(Объект.ДатаОкончания) Тогда
        Сообщить("Укажите дату окончания периода!");
        Возврат;
    КонецЕсли;
    
    КоличествоДоговоров = СформироватьОтчетИJSON_НаСервере();
    
    Если КоличествоДоговоров = 0 Тогда
        Сообщить("Нет данных за выбранный период или не заполнены договоры!");
        Возврат;
    КонецЕсли;
    
    // Переключаемся на вкладку предпросмотра
    Элементы.СтраницаПредпросмотр.Видимость = Истина;
    Элементы.СтраницаОтчет.Видимость = Ложь;
    
    Сообщить("Сформировано договоров: " + КоличествоДоговоров);
    
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьВTessa(Команда)
    
    Если ПустаяСтрока(Объект.ТекстJSON) Тогда
        Сообщить("Нет данных для отправки! Сначала сформируйте отчёт.");
        Возврат;
    КонецЕсли;
    
    Результат = ОтправитьJSON_НаСервере();
    
    Если Результат.Успешно Тогда
        Сообщить("Данные успешно отправлены в Tessa!");
        Сообщить("Код ответа: " + Результат.КодОтвета);
    Иначе
        Сообщить("Ошибка отправки: " + Результат.ТекстОшибки);
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура СохранитьJSONВФайл(Команда)
    
    Если ПустаяСтрока(Объект.ТекстJSON) Тогда
        Сообщить("Нет данных для сохранения!");
        Возврат;
    КонецЕсли;
    
    ИмяФайла = "MIDUpdateRequest_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".json";
    
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
    Диалог.Заголовок = "Сохранить JSON файл";
    Диалог.ПолноеИмяФайла = ИмяФайла;
    Диалог.Фильтр = "Файлы JSON (*.json)|*.json|Все файлы (*.*)|*.*";
    
    Если Диалог.Выбрать() Тогда
        
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        ТекстовыйДокумент.УстановитьТекст(Объект.ТекстJSON);
        
        Попытка
            ТекстовыйДокумент.Записать(Диалог.ПолноеИмяФайла, КодировкаТекста.UTF8);
            Сообщить("Файл сохранён: " + Диалог.ПолноеИмяФайла);
        Исключение
            Сообщить("Ошибка сохранения: " + ОписаниеОшибки());
        КонецПопытки;
        
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура ВернутьсяКОтчету(Команда)
    
    Элементы.СтраницаОтчет.Видимость = Истина;
    Элементы.СтраницаПредпросмотр.Видимость = Ложь;
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция СформироватьОтчетИJSON_НаСервере()
    
    Объект.ТаблицаПлатежей.Очистить();
    Объект.ТекстJSON = "";
    
    // Запрос к журналу документов
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Деньги.Ссылка КАК Документ,
    |    Деньги.Дата КАК ДатаПлатежа,
    |    Деньги.Номер КАК НомерПлатежа,
    |    Деньги.Организация КАК Организация,
    |    Деньги.Контрагент КАК Контрагент,
    |    Деньги.Валюта КАК Валюта,
    |    Деньги.Проведен КАК Проведен,
    |    ВЫБОР
    |        КОГДА Деньги.Доход > 0
    |            ТОГДА ""Поступление""
    |        КОГДА Деньги.Расход > 0
    |            ТОГДА ""Списание""
    |        ИНАЧЕ """"
    |    КОНЕЦ КАК ТипДокумента,
    |    ВЫБОР
    |        КОГДА Деньги.Доход > 0
    |            ТОГДА Деньги.Доход
    |        КОГДА Деньги.Расход > 0
    |            ТОГДА Деньги.Расход
    |        ИНАЧЕ 0
    |    КОНЕЦ КАК СуммаПлатежа
    |ИЗ
    |    ЖурналДокументов.Деньги КАК Деньги
    |ГДЕ
    |    Деньги.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    |    И Деньги.Проведен = ИСТИНА
    |    И (Деньги.Доход > 0 ИЛИ Деньги.Расход > 0)
    |
    |УПОРЯДОЧИТЬ ПО
    |    ДатаПлатежа";
    
    Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(Объект.ДатаНачала));
    Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        НоваяСтрока = Объект.ТаблицаПлатежей.Добавить();
        НоваяСтрока.ТипДокумента   = Выборка.ТипДокумента;
        НоваяСтрока.Организация    = Выборка.Организация;
        НоваяСтрока.Контрагент     = Выборка.Контрагент;
        НоваяСтрока.Документ       = Выборка.Документ;
        НоваяСтрока.ДатаПлатежа    = Выборка.ДатаПлатежа;
        НоваяСтрока.НомерПлатежа   = Выборка.НомерПлатежа;
        НоваяСтрока.Валюта         = Выборка.Валюта;
        НоваяСтрока.СуммаПлатежа   = Выборка.СуммаПлатежа;
        
        ПолучитьДетальныеДанные(НоваяСтрока);
        
    КонецЦикла;
    
    // Формируем JSON по формату ТЗ
    КоличествоДоговоров = СформироватьJSON_ПоФормату();
    
    Возврат КоличествоДоговоров;
    
КонецФункции

&НаСервере
Процедура ПолучитьДетальныеДанные(СтрокаТаблицы)
    
    Документ = СтрокаТаблицы.Документ;
    
    Если ТипЗнч(Документ) = Тип("ДокументСсылка.ПоступлениеНаРасчетныйСчет") Тогда
        
        СтрокаТаблицы.Договор = Документ.ДоговорКонтрагента;
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    СУММА(РасшифровкаПлатежа.СуммаНДС) КАК СуммаНДС,
        |    МАКСИМУМ(РасшифровкаПлатежа.ДоговорКонтрагента) КАК Договор
        |ИЗ
        |    Документ.ПоступлениеНаРасчетныйСчет.РасшифровкаПлатежа КАК РасшифровкаПлатежа
        |ГДЕ
        |    РасшифровкаПлатежа.Ссылка = &Документ";
        
        Запрос.УстановитьПараметр("Документ", Документ);
        Результат = Запрос.Выполнить();
        
        Если НЕ Результат.Пустой() Тогда
            Выборка = Результат.Выбрать();
            Выборка.Следующий();
            СтрокаТаблицы.СуммаНДС = Выборка.СуммаНДС;
            Если ЗначениеЗаполнено(Выборка.Договор) Тогда
                СтрокаТаблицы.Договор = Выборка.Договор;
            КонецЕсли;
        КонецЕсли;
        
    ИначеЕсли ТипЗнч(Документ) = Тип("ДокументСсылка.СписаниеСРасчетногоСчета") Тогда
        
        СтрокаТаблицы.Договор = Документ.ДоговорКонтрагента;
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    СУММА(РасшифровкаПлатежа.СуммаНДС) КАК СуммаНДС,
        |    МАКСИМУМ(РасшифровкаПлатежа.ДоговорКонтрагента) КАК Договор
        |ИЗ
        |    Документ.СписаниеСРасчетногоСчета.РасшифровкаПлатежа КАК РасшифровкаПлатежа
        |ГДЕ
        |    РасшифровкаПлатежа.Ссылка = &Документ";
        
        Запрос.УстановитьПараметр("Документ", Документ);
        Результат = Запрос.Выполнить();
        
        Если НЕ Результат.Пустой() Тогда
            Выборка = Результат.Выбрать();
            Выборка.Следующий();
            СтрокаТаблицы.СуммаНДС = Выборка.СуммаНДС;
            Если ЗначениеЗаполнено(Выборка.Договор) Тогда
                СтрокаТаблицы.Договор = Выборка.Договор;
            КонецЕсли;
        КонецЕсли;
        
    КонецЕсли;
    
КонецПроцедуры

&НаСервере
Функция СформироватьJSON_ПоФормату()
    
    // Группируем платежи по договорам
    СоответствиеДоговоров = Новый Соответствие;
    
    Для Каждого Строка Из Объект.ТаблицаПлатежей Цикл
        
        // Пропускаем строки без договора
        Если НЕ ЗначениеЗаполнено(Строка.Договор) Тогда
            Продолжить;
        КонецЕсли;
        
        // Получаем или создаём структуру договора
        ДанныеДоговора = СоответствиеДоговоров.Получить(Строка.Договор);
        
        Если ДанныеДоговора = Неопределено Тогда
            
            ДанныеДоговора = Новый Структура;
            
            // GUID - идентификатор договора в системе Tessa (TessaID)
            ДанныеДоговора.Вставить("GUID", ПолучитьTessaID(Строка.Договор));
            
            // ActualPayment - сумма оплаченная по договору (пока 0)
            ДанныеДоговора.Вставить("ActualPayment", 0);
            
            // ActualDelivery - сумма поступления ТМЦ/услуг (пока 0)
            ДанныеДоговора.Вставить("ActualDelivery", 0);
            
            // ReconciliationReportDate - текущая дата
            ДанныеДоговора.Вставить("ReconciliationReportDate", Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd"));
            
            // Completed - признак выполнения обязательств (передаём "Нет")
            ДанныеДоговора.Вставить("Completed", "Нет");
            
            // PaymentSchedule - массив оплат
            ДанныеДоговора.Вставить("PaymentSchedule", Новый Массив);
            
            СоответствиеДоговоров.Вставить(Строка.Договор, ДанныеДоговора);
            
        КонецЕсли;
        
        // Добавляем платёж только для списаний (документ Списание с расчетного счета)
        Если Строка.ТипДокумента = "Списание" Тогда
            
            Документ = Строка.Документ;
            
            СтруктураПлатежа = Новый Структура;
            
            // GUID_Link - идентификатор документа Списание с расчетного счета
            СтруктураПлатежа.Вставить("GUID_Link", XMLСтрока(Документ.УникальныйИдентификатор()));
            
            // Completed_Link - признак проведения ("1" или "0")
            СтруктураПлатежа.Вставить("Completed_Link", ?(Документ.Проведен, "1", "0"));
            
            // ScheduledPaymentDate - планируемая дата оплаты (ничего не передаём)
            СтруктураПлатежа.Вставить("ScheduledPaymentDate", "");
            
            // ActualPaymentDate - дата документа Списание с расчетного счета
            СтруктураПлатежа.Вставить("ActualPaymentDate", Формат(Строка.ДатаПлатежа, "ДФ=yyyy-MM-dd"));
            
            // Amount - сумма оплаты из документа
            СтруктураПлатежа.Вставить("Amount", Строка.СуммаПлатежа);
            
            // VAT_Amount - сумма НДС
            СтруктураПлатежа.Вставить("VAT_Amount", ?(Строка.СуммаНДС = Null, 0, Строка.СуммаНДС));
            
            // Currency - валюта платежа из документа
            СтруктураПлатежа.Вставить("Currency", Строка(Строка.Валюта));
            
            // Rate - кратность валюты
            Кратность = 1;
            Если ЗначениеЗаполнено(Строка.Валюта) Тогда
                Попытка
                    Кратность = Строка.Валюта.Кратность;
                Исключение
                    Кратность = 1;
                КонецПопытки;
            КонецЕсли;
            СтруктураПлатежа.Вставить("Rate", Кратность);
            
            // PaymentDocument - описание платёжного поручения
            // Формат: "Платежное поручение № [номер] от [дата]"
            ОписаниеПП = "Платежное поручение № " + СокрЛП(Строка.НомерПлатежа) + " от " + Формат(Строка.ДатаПлатежа, "ДФ=dd.MM.yyyy");
            СтруктураПлатежа.Вставить("PaymentDocument", ОписаниеПП);
            
            ДанныеДоговора.PaymentSchedule.Добавить(СтруктураПлатежа);
            
        КонецЕсли;
        
    КонецЦикла;
    
    // Формируем итоговый массив договоров
    МассивДоговоров = Новый Массив;
    Для Каждого КлючЗначение Из СоответствиеДоговоров Цикл
        МассивДоговоров.Добавить(КлючЗначение.Значение);
    КонецЦикла;
    
    // Формируем корневую структуру по ТЗ
    СтруктураJSON = Новый Структура;
    СтруктураJSON.Вставить("MIDUpdateRequest", МассивДоговоров);
    
    // Преобразуем в JSON с форматированием
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Авто, "  "));
    ЗаписатьJSON(ЗаписьJSON, СтруктураJSON);
    Объект.ТекстJSON = ЗаписьJSON.Закрыть();
    
    Возврат МассивДоговоров.Количество();
    
КонецФункции

&НаСервере
Функция ПолучитьTessaID(Договор)
    
    // Читаем из регистра
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    СоответствиеДоговоровTessa.TessaID
    |ИЗ
    |    РегистрСведений.СоответствиеДоговоровTessa КАК СоответствиеДоговоровTessa
    |ГДЕ
    |    СоответствиеДоговоровTessa.ДоговорКонтрагента = &Договор";
    
    Запрос.УстановитьПараметр("Договор", Договор);
    Результат = Запрос.Выполнить();
    
    Если НЕ Результат.Пустой() Тогда
        Выборка = Результат.Выбрать();
        Выборка.Следующий();
        Если ЗначениеЗаполнено(Выборка.TessaID) Тогда
            Возврат СокрЛП(Выборка.TessaID);
        КонецЕсли;
    КонецЕсли;
    
    // Если не найден — возвращаем УИД
    УИД = XMLСтрока(Договор.УникальныйИдентификатор());
    Возврат СтрЗаменить(УИД, "-", "");
    
КонецФункции


&НаСервере
Функция ОтправитьJSON_НаСервере()
    
    Результат = Новый Структура("Успешно, КодОтвета, ТекстОшибки", Ложь, 0, "");
    
    // Получаем адрес из константы
    АдресСервера = Константы.АдресСервераTessa.Получить();
    
    Если ПустаяСтрока(АдресСервера) Тогда
        Результат.ТекстОшибки = "Не заполнена константа 'АдресСервераTessa'!";
        Возврат Результат;
    КонецЕсли;
    
    Попытка
        
        // Разбираем URL
        СтруктураURL = РазобратьURL(АдресСервера);
        
        Если СтруктураURL = Неопределено Тогда
            Результат.ТекстОшибки = "Некорректный адрес сервера: " + АдресСервера;
            Возврат Результат;
        КонецЕсли;
        
        // Определяем порт и защищённое соединение
        Если СтруктураURL.Схема = "https" Тогда
            Порт = ?(СтруктураURL.Порт = 0, 443, СтруктураURL.Порт);
            ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL();
        Иначе
            Порт = ?(СтруктураURL.Порт = 0, 80, СтруктураURL.Порт);
            ЗащищенноеСоединение = Неопределено;
        КонецЕсли;
        
        // Создаём HTTP-соединение
        Соединение = Новый HTTPСоединение(
            СтруктураURL.Сервер,
            Порт,
            ,  // Пользователь
            ,  // Пароль
            ,  // Прокси
            60, // Таймаут
            ЗащищенноеСоединение
        );
        
        // Формируем заголовки запроса
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Заголовки.Вставить("Accept", "application/json");
        
        // Путь для запроса
        Путь = СтруктураURL.Путь;
        Если ПустаяСтрока(Путь) Тогда
            Путь = "/";
        КонецЕсли;
        
        // Создаём HTTP-запрос
        HTTPЗапрос = Новый HTTPЗапрос(Путь, Заголовки);
        HTTPЗапрос.УстановитьТелоИзСтроки(Объект.ТекстJSON, КодировкаТекста.UTF8);
        
        // Отправляем POST-запрос
        HTTPОтвет = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
        
        Результат.КодОтвета = HTTPОтвет.КодСостояния;
        
        // Проверяем результат
        Если HTTPОтвет.КодСостояния >= 200 И HTTPОтвет.КодСостояния < 300 Тогда
            Результат.Успешно = Истина;
        Иначе
            Результат.ТекстОшибки = "Код ответа: " + HTTPОтвет.КодСостояния + ". Тело: " + HTTPОтвет.ПолучитьТелоКакСтроку();
        КонецЕсли;
        
    Исключение
        Результат.ТекстОшибки = ОписаниеОшибки();
    КонецПопытки;
    
    Возврат Результат;
    
КонецФункции

&НаСервере
Функция РазобратьURL(URL)
    
    // Разбираем URL на составляющие
    Результат = Новый Структура("Схема, Сервер, Порт, Путь", "", "", 0, "");
    
    СтрокаURL = URL;
    
    // Определяем схему (http/https)
    Если НРег(Лев(СтрокаURL, 8)) = "https://" Тогда
        Результат.Схема = "https";
        СтрокаURL = Сред(СтрокаURL, 9);
    ИначеЕсли НРег(Лев(СтрокаURL, 7)) = "http://" Тогда
        Результат.Схема = "http";
        СтрокаURL = Сред(СтрокаURL, 8);
    Иначе
        Возврат Неопределено;
    КонецЕсли;
    
    // Отделяем путь от хоста
    ПозицияПути = СтрНайти(СтрокаURL, "/");
    Если ПозицияПути > 0 Тогда
        Результат.Путь = Сред(СтрокаURL, ПозицияПути);
        СтрокаURL = Лев(СтрокаURL, ПозицияПути - 1);
    Иначе
        Результат.Путь = "/";
    КонецЕсли;
    
    // Отделяем порт от хоста
    ПозицияПорта = СтрНайти(СтрокаURL, ":");
    Если ПозицияПорта > 0 Тогда
        Результат.Сервер = Лев(СтрокаURL, ПозицияПорта - 1);
        Результат.Порт = Число(Сред(СтрокаURL, ПозицияПорта + 1));
    Иначе
        Результат.Сервер = СтрокаURL;
        Результат.Порт = 0;
    КонецЕсли;
    
    Возврат Результат;
    
КонецФункции

#КонецОбласти
